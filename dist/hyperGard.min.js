!function(n,e){typeof exports==='object'&&typeof module!=='undefined'?module.exports=e():typeof define==='function'&&define.amd?define('HyperGard',e):(n.HyperGard=e())}(this,(function(){"use strict";var n={},e=[].slice,t=n.toString,r=function(e){if(e==null){return e+''}return typeof e==='object'||typeof e==='function'?n[t.call(e)]||'object':typeof e},o=function(n){return r(n)==='buffer'||r(n)==='date'||r(n)==='regexp'},u=function(n){var e=r(n),t;if(e==='buffer'){t=new Buffer(n.length);n.copy(t);return t}if(e==='date'){return new Date(n.getTime())}if(e==='regexp'){return new RegExp(n)}throw new Error('Unexpected situation')},i=function(n){var e=[];n.forEach(function(n,t){r(n)==='object'?(Array.isArray(n)?(e[t]=i(n)):o(n)?(e[t]=u(n)):(e[t]=c({},n))):(e[t]=n)});return e},c=function(){if(arguments.length<1||r(arguments[0])!=='object'){return!1}if(arguments.length<2){return arguments[0]}var n=arguments[0],t=e.call(arguments,1),f,a;t.forEach(function(e){if(r(e)!=='object'||Array.isArray(e)){return}Object.keys(e).forEach(function(t){a=n[t];f=e[t];f!==n&&(r(f)!=='object'||f===null?(n[t]=f):Array.isArray(f)?(n[t]=i(f)):o(f)?(n[t]=u(f)):r(a)!=='object'||a===null||Array.isArray(a)?(n[t]=c({},f)):(n[t]=c(a,f)))})});return n};['Boolean','Number','String','Function','Array','Date','RegExp','Object','Error'].forEach(function(e){n["[object "+e+"]"]=e.toLowerCase()});var f='4.0.0',a={preloadHomepage:!0,cacheHomepage:!1,debug:!1,xhr:{headers:{Accept:'application/hal+json, application/json, */*; q=0.01','X-HyperGard':f}}},s=/^(head|get)$/i,l=/^(_embedded|_links|_forms)$/;function d(n,e){var t=c({},a.xhr,e);return Promise.race([p(e.timeout||6e4),fetch(n,t)]).then(g)}function h(n){return!!n&&{}.toString.call(n)==='[object Object]'}function g(n){return n.status>=200&&n.status<300?n:Promise.reject(n instanceof Response?n:new Response('',{status:503,statusText:'Possible CORS error'}))}function p(n){return new Promise(function(e,t){setTimeout(function(){t({error:{code:'0011',msg:'Fetch timeout',timeout:n}})},n)})}function m(n){return Object.keys(n).map(function(e){return encodeURIComponent(e)+'='+encodeURIComponent(n[e])}).join('&')}function y(n,e,t,r,o){var u=this,i=(t.href||t.action||'').replace(/^#/,''),c=t.method||(o==='form'?'POST':'GET'),f='',a='';u.getActionName=function(){return e};u.getActionType=function(){return o};u.getActionUrl=function(){return f};u.getMethod=function(){return c};u.getParams=function(){return urltemplate.extractParams(i)};u.getRawActionUrl=function(){return i};u.getTitle=function(){return t.title||''};u.isTemplated=function(){return t.templated||!1};u.setParams=function(e){f=t.templated?urltemplate.expand(i,e||{}):i;f&&(f=urlparse.urljoin(t.curie?t.curie.href:n.getBase(),f));o==='form'&&(t.fields&&h(e)?(a={},Object.keys(t.fields).forEach(function(n){e.hasOwnProperty(n)?(a[n]=e[n]):t.fields[n].hasOwnProperty('default')&&(a[n]=t.fields[n]['default'])})):e&&(a=JSON.stringify(e)),s.test(c)&&a&&(f=urlparse.urljoin(f,'?'+m(a)),a=''));return u};o==='form'&&(u.getFields=function(){return t.fields||{}},u.getPayload=function(){return a});t.curie&&(u.getDocUrl=function(){return urltemplate.expand(t.curie.href,{rel:e.split(':')[1]})});u.setParams(r)}var b=d;function j(n,e){var t,r=!1,o=c({},a,e||{}),u={},i=function(n){var e={};(n||[]).forEach(function(n){n.name&&(e[n.name]=n)});return e},f=function(n,e){var t={};Object.keys(n).forEach(function(r){t[r]=Array.isArray(n[r])?n[r].map(function(n){return new g(n,e)}):new g(n[r],e)});return t},d=function(n,e,t,r){var c={},a=((e._links||{}).self||{}).href||'',s=[],d=f(e._embedded||{},n);Object.keys(e).forEach(function(n){l.test(n)||(this[n]=e[n])},c);n.getAction=function(n,t){if(!s[n]){s[n]=[];var r=i((e._links||{}).curies),o=i((e._forms||{}).curies),u=String(n).split(':')[0]||'';[].concat.call([],(e._links||{})[n]).forEach(function(e){e&&(e.curie=r[u],s[n].push(new y(this,n,e,t,'link')))},this);[].concat.call([],(e._forms||{})[n]).forEach(function(e){e&&(e.curie=o[u],s[n].push(new y(this,n,e,t,'form')))},this)}return s[n].map(function(n){return n.setParams(t)})};n.getBase=function(){return r||t.getBase()};n.getEmbedded=function(n){return d[n]};n.fetchEmbedded=function(n,e){return this.hasEmbedded(n)?Promise.resolve({data:this.getEmbedded(n)}):this.getFirstAction(n).fetch(e)};n.getFirstAction=function(n,e){return this.getAction(n,e)[0]||new y(this,n,{},{},'none')};n.getParent=function(){return t};n.getProp=function(n){return c[n]};n.getProps=function(){return c};n.hasAction=function(e){return n.hasLink(e)||n.hasForm(e)};n.hasEmbedded=function(n){return!!d[n]};n.hasForm=function(e){return n.listActions().forms.indexOf(e)>=0};n.hasLink=function(e){return n.listActions().links.indexOf(e)>=0};n.listActions=function(){var n=function(n){return n!=='curies'};return{links:Object.keys(e._links||{}).filter(n),forms:Object.keys(e._forms||{}).filter(n)}};n.listEmbedded=function(){return Object.keys(d)};o.debug&&(n.resource=e);r||(n.getRoot=function(){var n;do{n=this.getParent()}while(!(n instanceof p));return n});a&&(u[a]=n)},g=function(n,e){return d(this,n||{},e)},p=function(n,e){return d(this,e,this,n)};y.prototype.fetch=function(n){n||(n={});var e=n.url||this.getActionUrl(),t=this.getRawActionUrl(),r=this.getActionName(),i=this.getPayload?this.getPayload():'',f=c({method:this.getMethod(),action:r},o.xhr,n),a=function(n){if(n.status===204){return Promise.resolve({action:r,data:'',xhr:n})}return n.json().then(function(t){return{action:r,data:h(t)?new p(e,t):n.text(),xhr:n}},function(){return{action:r,data:n.text(),xhr:n}})},l=function(n){return Promise.reject(n instanceof Response?{error:{action:r,code:'0021',msg:'Failed to retrieve action'},xhr:n}:n)};!s.test(f.method)&&h(i)&&(f.headers['Content-Type']='application/x-www-form-urlencoded',f.body=m(i));if(!e){return Promise.reject({error:{action:r,code:'0020',msg:'Url is not provided for this action'}})}else if(f.method==='GET'&&!n.force&&u.hasOwnProperty(t)){return Promise.resolve({action:r,data:u[t]})}return b(e,f).then(a,l)};this.fetch=function(){var e=c({method:'GET',action:'homepage'},o.xhr),u=function(e){o.cacheHomepage||(r=!1);return e.json().then(function(t){return h(t)?{data:new p(n,t),xhr:e}:Promise.reject()})['catch'](function(){return Promise.reject({error:{code:'0002',msg:'Could not parse homepage'},xhr:e})})},i=function(n){r=!1;return Promise.reject(n instanceof Response?{error:{code:'0001',msg:'Failed to retrieve homepage'},xhr:n}:n)};if(!n){return Promise.reject({error:{code:'0000',msg:'API endpoint was not provided'}})}r||(r=!0,t=b(n,e).then(u,i));return t};this.setOptions=function(n){c(o,n||{});return this};this.getOptions=function(){return o};this.parse=function(e){return new p(n,e||{})};o.preloadHomepage&&this.fetch()}j.prototype.version=f;function w(n){b=(function(e){return function(t,r){return n(t,r,e)}})(b)}j.prototype.applyMiddlewareStack=function(n){var e;n&&Array.isArray(n)&&n.length&&(e=n.reverse(),e.forEach(w))};return j}))