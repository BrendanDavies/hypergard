"use strict";var typeObj={},slice=[].slice,toString=typeObj.toString,getType=function(n){if(n==null){return n+''}return typeof n==='object'||typeof n==='function'?typeObj[toString.call(n)]||'object':typeof n},isSpecificValue=function(n){return getType(n)==='buffer'||getType(n)==='date'||getType(n)==='regexp'},cloneSpecificValue=function(n){var e=getType(n),t;if(e==='buffer'){t=new Buffer(n.length);n.copy(t);return t}if(e==='date'){return new Date(n.getTime())}if(e==='regexp'){return new RegExp(n)}throw new Error('Unexpected situation')},deepCloneArray=function(n){var e=[];n.forEach(function(n,t){getType(n)==='object'?(Array.isArray(n)?(e[t]=deepCloneArray(n)):isSpecificValue(n)?(e[t]=cloneSpecificValue(n)):(e[t]=deepExtend({},n))):(e[t]=n)});return e},deepExtend=function(){if(arguments.length<1||getType(arguments[0])!=='object'){return!1}if(arguments.length<2){return arguments[0]}var n=arguments[0],e=slice.call(arguments,1),t,r;e.forEach(function(e){if(getType(e)!=='object'||Array.isArray(e)){return}Object.keys(e).forEach(function(o){r=n[o];t=e[o];t!==n&&(getType(t)!=='object'||t===null?(n[o]=t):Array.isArray(t)?(n[o]=deepCloneArray(t)):isSpecificValue(t)?(n[o]=cloneSpecificValue(t)):getType(r)!=='object'||r===null||Array.isArray(r)?(n[o]=deepExtend({},t)):(n[o]=deepExtend(r,t)))})});return n};['Boolean','Number','String','Function','Array','Date','RegExp','Object','Error'].forEach(function(n){typeObj["[object "+n+"]"]=n.toLowerCase()});var version='4.0.0',defaultOptions={preloadHomepage:!0,cacheHomepage:!1,debug:!1,xhr:{headers:{Accept:'application/hal+json, application/json, */*; q=0.01','X-HyperGard':version}}},excludeBody=/^(head|get)$/i,excludedProps=/^(_embedded|_links|_forms)$/;function load(n,e){var t=deepExtend({},defaultOptions.xhr,e);return Promise.race([xhrTimeout(e.timeout||6e4),fetch(n,t)]).then(xhrStatus)}function isObject(n){return!!n&&{}.toString.call(n)==='[object Object]'}function xhrStatus(n){return n.status>=200&&n.status<300?n:Promise.reject(n instanceof Response?n:new Response('',{status:503,statusText:'Possible CORS error'}))}function xhrTimeout(n){return new Promise(function(e,t){setTimeout(function(){t({error:{code:'0011',msg:'Fetch timeout',timeout:n}})},n)})}var loadNetworkResource=load;function urlSerialize(n){return Object.keys(n).map(function(e){return encodeURIComponent(e)+'='+encodeURIComponent(n[e])}).join('&')}function applyMiddleware(n){loadNetworkResource=(function(e){return function(t,r){return n(t,r,e)}})(loadNetworkResource)}function Action(n,e,t,r,o){var u=this,i=(t.href||t.action||'').replace(/^#/,''),c=t.method||(o==='form'?'POST':'GET'),f='',a='';u.getActionName=function(){return e};u.getActionType=function(){return o};u.getActionUrl=function(){return f};u.getMethod=function(){return c};u.getParams=function(){return urltemplate.extractParams(i)};u.getRawActionUrl=function(){return i};u.getTitle=function(){return t.title||''};u.isTemplated=function(){return t.templated||!1};u.setParams=function(e){f=t.templated?urltemplate.expand(i,e||{}):i;f&&(f=urlparse.urljoin(t.curie?t.curie.href:n.getBase(),f));o==='form'&&(t.fields&&isObject(e)?(a={},Object.keys(t.fields).forEach(function(n){e.hasOwnProperty(n)?(a[n]=e[n]):t.fields[n].hasOwnProperty('default')&&(a[n]=t.fields[n]['default'])})):e&&(a=JSON.stringify(e)),excludeBody.test(c)&&a&&(f=urlparse.urljoin(f,'?'+urlSerialize(a)),a=''));return u};o==='form'&&(u.getFields=function(){return t.fields||{}},u.getPayload=function(){return a});t.curie&&(u.getDocUrl=function(){return urltemplate.expand(t.curie.href,{rel:e.split(':')[1]})});u.setParams(r)}var concat=[].concat,keys=Object.keys,HyperGard=function(n,e){var t,r=!1,o=deepExtend({},defaultOptions,e||{}),u={},i=function(n){var e={};(n||[]).forEach(function(n){n.name&&(e[n.name]=n)});return e},c=function(n,e){var t={};keys(n).forEach(function(r){t[r]=Array.isArray(n[r])?n[r].map(function(n){return new a(n,e)}):new a(n[r],e)});return t},f=function(n,e,t,r){var f={},a=((e._links||{}).self||{}).href||'',l=[],d=c(e._embedded||{},n);keys(e).forEach(function(n){excludedProps.test(n)||(this[n]=e[n])},f);n.getAction=function(n,t){if(!l[n]){l[n]=[];var r=i((e._links||{}).curies),o=i((e._forms||{}).curies),u=String(n).split(':')[0]||'';concat.call([],(e._links||{})[n]).forEach(function(e){e&&(e.curie=r[u],l[n].push(new Action(this,n,e,t,'link')))},this);concat.call([],(e._forms||{})[n]).forEach(function(e){e&&(e.curie=o[u],l[n].push(new Action(this,n,e,t,'form')))},this)}return l[n].map(function(n){return n.setParams(t)})};n.getBase=function(){return r||t.getBase()};n.getEmbedded=function(n){return d[n]};n.fetchEmbedded=function(n,e){return this.hasEmbedded(n)?Promise.resolve({data:this.getEmbedded(n)}):this.getFirstAction(n).fetch(e)};n.getFirstAction=function(n,e){return this.getAction(n,e)[0]||new Action(this,n,{},{},'none')};n.getParent=function(){return t};n.getProp=function(n){return f[n]};n.getProps=function(){return f};n.hasAction=function(e){return n.hasLink(e)||n.hasForm(e)};n.hasEmbedded=function(n){return!!d[n]};n.hasForm=function(e){return n.listActions().forms.indexOf(e)>=0};n.hasLink=function(e){return n.listActions().links.indexOf(e)>=0};n.listActions=function(){var n=function(n){return n!=='curies'};return{links:keys(e._links||{}).filter(n),forms:keys(e._forms||{}).filter(n)}};n.listEmbedded=function(){return keys(d)};o.debug&&(n.resource=e);r||(n.getRoot=function(){var n;do{n=this.getParent()}while(!(n instanceof s));return n});a&&(u[a]=n)},a=function(n,e){return f(this,n||{},e)},s=function(n,e){return f(this,e,this,n)};Action.prototype.fetch=function(n){n||(n={});var e=n.url||this.getActionUrl(),t=this.getRawActionUrl(),r=this.getActionName(),i=this.getPayload?this.getPayload():'',c=deepExtend({method:this.getMethod(),action:r},o.xhr,n),f=function(n){if(n.status===204){return Promise.resolve({action:r,data:'',xhr:n})}return n.json().then(function(t){return{action:r,data:isObject(t)?new s(e,t):n.text(),xhr:n}},function(){return{action:r,data:n.text(),xhr:n}})},a=function(n){return Promise.reject(n instanceof Response?{error:{action:r,code:'0021',msg:'Failed to retrieve action'},xhr:n}:n)};!excludeBody.test(c.method)&&isObject(i)&&(c.headers['Content-Type']='application/x-www-form-urlencoded',c.body=urlSerialize(i));if(!e){return Promise.reject({error:{action:r,code:'0020',msg:'Url is not provided for this action'}})}else if(c.method==='GET'&&!n.force&&u.hasOwnProperty(t)){return Promise.resolve({action:r,data:u[t]})}return loadNetworkResource(e,c).then(f,a)};this.fetch=function(){var e=deepExtend({method:'GET',action:'homepage'},o.xhr),u=function(e){o.cacheHomepage||(r=!1);return e.json().then(function(t){return isObject(t)?{data:new s(n,t),xhr:e}:Promise.reject()})['catch'](function(){return Promise.reject({error:{code:'0002',msg:'Could not parse homepage'},xhr:e})})},i=function(n){r=!1;return Promise.reject(n instanceof Response?{error:{code:'0001',msg:'Failed to retrieve homepage'},xhr:n}:n)};if(!n){return Promise.reject({error:{code:'0000',msg:'API endpoint was not provided'}})}r||(r=!0,t=loadNetworkResource(n,e).then(u,i));return t};this.setOptions=function(n){deepExtend(o,n||{});return this};this.getOptions=function(){return o};this.parse=function(e){return new s(n,e||{})};o.preloadHomepage&&this.fetch()};HyperGard.prototype.version=version;HyperGard.prototype.applyMiddlewareStack=function(n){var e;n&&Array.isArray(n)&&n.length&&(e=n.reverse(),e.forEach(applyMiddleware))};export default HyperGard