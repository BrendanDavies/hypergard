"use strict";var typeObj={},slice=[].slice,toString=typeObj.toString,getType=function(e){if(e==null){return e+''}return typeof e==='object'||typeof e==='function'?typeObj[toString.call(e)]||'object':typeof e},isSpecificValue=function(e){return getType(e)==='buffer'||getType(e)==='date'||getType(e)==='regexp'},cloneSpecificValue=function(e){var n=getType(e),t;if(n==='buffer'){t=new Buffer(e.length);e.copy(t);return t}if(n==='date'){return new Date(e.getTime())}if(n==='regexp'){return new RegExp(e)}throw new Error('Unexpected situation')},deepCloneArray=function(e){var n=[];e.forEach(function(e,t){getType(e)==='object'?(Array.isArray(e)?(n[t]=deepCloneArray(e)):isSpecificValue(e)?(n[t]=cloneSpecificValue(e)):(n[t]=deepExtend({},e))):(n[t]=e)});return n},deepExtend=function(){if(arguments.length<1||getType(arguments[0])!=='object'){return!1}if(arguments.length<2){return arguments[0]}var e=arguments[0],n=slice.call(arguments,1),t,r;n.forEach(function(n){if(getType(n)!=='object'||Array.isArray(n)){return}Object.keys(n).forEach(function(o){r=e[o];t=n[o];t!==e&&(getType(t)!=='object'||t===null?(e[o]=t):Array.isArray(t)?(e[o]=deepCloneArray(t)):isSpecificValue(t)?(e[o]=cloneSpecificValue(t)):getType(r)!=='object'||r===null||Array.isArray(r)?(e[o]=deepExtend({},t)):(e[o]=deepExtend(r,t)))})});return e};['Boolean','Number','String','Function','Array','Date','RegExp','Object','Error'].forEach(function(e){typeObj["[object "+e+"]"]=e.toLowerCase()});var version='4.0.0',defaultOptions={preloadHomepage:!0,cacheHomepage:!1,debug:!1,xhr:{headers:{Accept:'application/hal+json, application/json, */*; q=0.01','X-HyperGard':version}}},excludeBody=/^(head|get)$/i,excludedProps=/^(_embedded|_links|_forms)$/;function load(e,n){var t=deepExtend({},defaultOptions.xhr,n);return Promise.race([xhrTimeout(n.timeout||6e4),fetch(e,t)]).then(xhrStatus)}function isObject(e){return!!e&&{}.toString.call(e)==='[object Object]'}function xhrStatus(e){return e.status>=200&&e.status<300?e:Promise.reject(e instanceof Response?e:new Response('',{status:503,statusText:'Possible CORS error'}))}function xhrTimeout(e){return new Promise(function(n,t){setTimeout(function(){t({error:{code:'0011',msg:'Fetch timeout',timeout:e}})},e)})}var loadNetworkResource=load;function urlSerialize(e){return Object.keys(e).map(function(n){return encodeURIComponent(n)+'='+encodeURIComponent(e[n])}).join('&')}function applyMiddleware(e){loadNetworkResource=(function(n){return function(t,r){return e(t,r,n)}})(loadNetworkResource)}function Action(e,n,t,r,o){var u=this,i=(t.href||t.action||'').replace(/^#/,''),c=t.method||(o==='form'?'POST':'GET'),f='',s='';u.getActionName=function(){return n};u.getActionType=function(){return o};u.getActionUrl=function(){return f};u.getMethod=function(){return c};u.getParams=function(){return urltemplate.extractParams(i)};u.getRawActionUrl=function(){return i};u.getTitle=function(){return t.title||''};u.isTemplated=function(){return t.templated||!1};u.setParams=function(n){f=t.templated?urltemplate.expand(i,n||{}):i;f&&(f=urlparse.urljoin(t.curie?t.curie.href:e.getBase(),f));o==='form'&&(t.fields&&isObject(n)?(s={},Object.keys(t.fields).forEach(function(e){n.hasOwnProperty(e)?(s[e]=n[e]):t.fields[e].hasOwnProperty('default')&&(s[e]=t.fields[e]['default'])})):n&&(s=JSON.stringify(n)),excludeBody.test(c)&&s&&(f=urlparse.urljoin(f,'?'+urlSerialize(s)),s=''));return u};o==='form'&&(u.getFields=function(){return t.fields||{}},u.getPayload=function(){return s});t.curie&&(u.getDocUrl=function(){return urltemplate.expand(t.curie.href,{rel:n.split(':')[1]})});u.setParams(r)}function HyperGard(e,n){var t,r=!1,o=deepExtend({},defaultOptions,n||{}),u={},i=function(e){var n={};(e||[]).forEach(function(e){e.name&&(n[e.name]=e)});return n},c=function(e,n){var t={};Object.keys(e).forEach(function(r){t[r]=Array.isArray(e[r])?e[r].map(function(e){return new s(e,n)}):new s(e[r],n)});return t},f=function(e,n,t,r){var f={},s=((n._links||{}).self||{}).href||'',l=[],d=c(n._embedded||{},e);Object.keys(n).forEach(function(e){excludedProps.test(e)||(this[e]=n[e])},f);e.getAction=function(e,t){if(!l[e]){l[e]=[];var r=i((n._links||{}).curies),o=i((n._forms||{}).curies),u=String(e).split(':')[0]||'';[].concat.call([],(n._links||{})[e]).forEach(function(n){n&&(n.curie=r[u],l[e].push(new Action(this,e,n,t,'link')))},this);[].concat.call([],(n._forms||{})[e]).forEach(function(n){n&&(n.curie=o[u],l[e].push(new Action(this,e,n,t,'form')))},this)}return l[e].map(function(e){return e.setParams(t)})};e.getBase=function(){return r||t.getBase()};e.getEmbedded=function(e){return d[e]};e.fetchEmbedded=function(e,n){return this.hasEmbedded(e)?Promise.resolve({data:this.getEmbedded(e)}):this.getFirstAction(e).fetch(n)};e.getFirstAction=function(e,n){return this.getAction(e,n)[0]||new Action(this,e,{},{},'none')};e.getParent=function(){return t};e.getProp=function(e){return f[e]};e.getProps=function(){return f};e.hasAction=function(n){return e.hasLink(n)||e.hasForm(n)};e.hasEmbedded=function(e){return!!d[e]};e.hasForm=function(n){return e.listActions().forms.indexOf(n)>=0};e.hasLink=function(n){return e.listActions().links.indexOf(n)>=0};e.listActions=function(){var e=function(e){return e!=='curies'};return{links:Object.keys(n._links||{}).filter(e),forms:Object.keys(n._forms||{}).filter(e)}};e.listEmbedded=function(){return Object.keys(d)};o.debug&&(e.resource=n);r||(e.getRoot=function(){var e;do{e=this.getParent()}while(!(e instanceof a));return e});s&&(u[s]=e)},s=function(e,n){return f(this,e||{},n)},a=function(e,n){return f(this,n,this,e)};Action.prototype.fetch=function(e){e||(e={});var n=e.url||this.getActionUrl(),t=this.getRawActionUrl(),r=this.getActionName(),i=this.getPayload?this.getPayload():'',c=deepExtend({method:this.getMethod(),action:r},o.xhr,e),f=function(e){if(e.status===204){return Promise.resolve({action:r,data:'',xhr:e})}return e.json().then(function(t){return{action:r,data:isObject(t)?new a(n,t):e.text(),xhr:e}},function(){return{action:r,data:e.text(),xhr:e}})},s=function(e){return Promise.reject(e instanceof Response?{error:{action:r,code:'0021',msg:'Failed to retrieve action'},xhr:e}:e)};!excludeBody.test(c.method)&&isObject(i)&&(c.headers['Content-Type']='application/x-www-form-urlencoded',c.body=urlSerialize(i));if(!n){return Promise.reject({error:{action:r,code:'0020',msg:'Url is not provided for this action'}})}else if(c.method==='GET'&&!e.force&&u.hasOwnProperty(t)){return Promise.resolve({action:r,data:u[t]})}return loadNetworkResource(n,c).then(f,s)};this.fetch=function(){var n=deepExtend({method:'GET',action:'homepage'},o.xhr),u=function(n){o.cacheHomepage||(r=!1);return n.json().then(function(t){return isObject(t)?{data:new a(e,t),xhr:n}:Promise.reject()})['catch'](function(){return Promise.reject({error:{code:'0002',msg:'Could not parse homepage'},xhr:n})})},i=function(e){r=!1;return Promise.reject(e instanceof Response?{error:{code:'0001',msg:'Failed to retrieve homepage'},xhr:e}:e)};if(!e){return Promise.reject({error:{code:'0000',msg:'API endpoint was not provided'}})}r||(r=!0,t=loadNetworkResource(e,n).then(u,i));return t};this.setOptions=function(e){deepExtend(o,e||{});return this};this.getOptions=function(){return o};this.parse=function(n){return new a(e,n||{})};o.preloadHomepage&&this.fetch()}HyperGard.prototype.version=version;HyperGard.prototype.applyMiddlewareStack=function(e){var n;e&&Array.isArray(e)&&e.length&&(n=e.reverse(),n.forEach(applyMiddleware))};export default HyperGard